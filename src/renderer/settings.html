<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Employee Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="text"],
        input[type="number"],
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
        }

        .help-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sync-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .sync-info h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .sync-info p {
            color: #424242;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Settings</h1>
        
        <div id="statusMessage" style="display: none;"></div>
        
        <form id="settingsForm">
            <div class="form-group">
                <label for="serverUrl">Server URL</label>
                <input type="url" id="serverUrl" name="server_url" placeholder="http://192.168.1.71:3001/api/tables/emp_list/data">
                <div class="help-text">URL to fetch employee data from your server</div>
            </div>
            
            <div class="form-group">
                <label for="syncInterval">Sync Interval (minutes)</label>
                <input type="number" id="syncInterval" name="sync_interval" min="1" max="1440" placeholder="5">
                <div class="help-text">How often to sync employee data (1-1440 minutes)</div>
            </div>
            
            <div class="form-group">
                <label for="gracePeriod">Grace Period (minutes)</label>
                <input type="number" id="gracePeriod" name="grace_period" min="0" max="30" placeholder="5">
                <div class="help-text">Late arrival tolerance (0-30 minutes)</div>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-success" id="syncNowBtn">üîÑ Sync Now</button>
                <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">‚ùå Cancel</button>
            </div>
        </form>
        
        <div class="sync-info" id="syncInfo" style="display: none;">
            <h3>üìä Sync Information</h3>
            <p id="employeeCount">Employees in database: Loading...</p>
            <p id="lastSync">Last sync: Loading...</p>
            <p id="profileStatus">Profile images: Loading...</p>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        class SettingsApp {
            constructor() {
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadSettings();
                await this.loadSyncInfo();
            }

            setupEventListeners() {
                const form = document.getElementById('settingsForm');
                const syncNowBtn = document.getElementById('syncNowBtn');
                const cancelBtn = document.getElementById('cancelBtn');

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings();
                });

                syncNowBtn.addEventListener('click', () => {
                    this.syncNow();
                });

                cancelBtn.addEventListener('click', () => {
                    window.close();
                });
            }

            async loadSettings() {
                try {
                    const result = await ipcRenderer.invoke('get-settings');
                    
                    if (result.success) {
                        const settings = result.data;
                        
                        document.getElementById('serverUrl').value = settings.server_url || '';
                        document.getElementById('syncInterval').value = Math.floor((settings.sync_interval || 300000) / 60000);
                        document.getElementById('gracePeriod').value = settings.grace_period || 5;
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.showStatus('Error loading settings', 'error');
                }
            }

            async saveSettings() {
                try {
                    const formData = new FormData(document.getElementById('settingsForm'));
                    const settings = {
                        server_url: formData.get('server_url'),
                        sync_interval: (parseInt(formData.get('sync_interval')) * 60000).toString(),
                        grace_period: formData.get('grace_period')
                    };

                    const result = await ipcRenderer.invoke('update-settings', settings);
                    
                    if (result.success) {
                        this.showStatus('Settings saved successfully!', 'success');
                    } else {
                        this.showStatus(result.error || 'Error saving settings', 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showStatus('Error saving settings', 'error');
                }
            }

            async syncNow() {
                const syncBtn = document.getElementById('syncNowBtn');
                const originalText = syncBtn.textContent;
                
                syncBtn.textContent = 'üîÑ Syncing...';
                syncBtn.disabled = true;
                
                try {
                    const result = await ipcRenderer.invoke('sync-employees');
                    
                    if (result.success) {
                        this.showStatus(result.message, 'success');
                        await this.loadSyncInfo();
                    } else {
                        this.showStatus(result.error || 'Sync failed', 'error');
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    this.showStatus('Sync error occurred', 'error');
                } finally {
                    syncBtn.textContent = originalText;
                    syncBtn.disabled = false;
                }
            }

            async loadSyncInfo() {
                try {
                    const employeesResult = await ipcRenderer.invoke('get-employees');
                    
                    if (employeesResult.success) {
                        document.getElementById('employeeCount').textContent = 
                            `Employees in database: ${employeesResult.data.length}`;
                        
                        const profileResult = await ipcRenderer.invoke('check-profile-images');
                        if (profileResult.success) {
                            document.getElementById('profileStatus').textContent = 
                                `Profile images: ${profileResult.downloaded}/${profileResult.total} downloaded`;
                        }
                        
                        document.getElementById('syncInfo').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading sync info:', error);
                }
            }

            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('statusMessage');
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new SettingsApp();
        });
    </script>
</body>
</html>
